uri: https://github.com/emacs-mirror/emacs.git
branch: master
locald: repos/emacs-gui
lock: locks/emacs-gui.lock
# emacs-30.1
shell:
  - "arch"
  - "--arm64e"
  - "/bin/bash"
env:
  _IVG_APP: /Applications/Emacs-GUI.app
  _IVG_BACKUP: "${_IVG_APP}.bk"
  CFLAGS: >-
    -I/opt/homebrew/opt/llvm/lib/clang/21/include
    -I/opt/homebew/include
    -O2
    -DFD_SETSIZE=10000
    -DDARWIN_UNLIMITED_SELECT
    -I/opt/homebrew/opt/sqlite/include
    -I/opt/homebrew/opt/libgccjit/include
    -I/opt/homebrew/opt/ncurses/include
  LDFLAGS: >-
    -L/opt/homebrew/opt/llvm/lib/clang/21/lib/darwin
    -L/opt/homebrew/lib
    -L/opt/homebrew/opt/sqlite/lib
    -I/opt/homebrew/opt/libgccjit/include
    -L/opt/homebrew/opt/ncurses/lib
  CC: >-
    /opt/homebrew/opt/llvm/bin/clang
    -std=c23
setup:
  - |
    if [ -d "$_IVG_APP" ]; then
      rm -rf $_IVG_BACKUP
      mv $_IVG_APP $_IVG_BACKUP
    else
      echo "First time installation..."
    fi
  - brew install --build-from-source gcc
  - brew install --build-from-source libgccjit
  - >-
    brew install
    llvm
    ncurses
    make
    autoconf
    gnu-sed
    gnu-tar
    grep
    awk
    coreutils
    pkg-config
    texinfo
    xz
    m4
    cmigemo
    gnutls
    gmp
    zlib
    gtk+
install:
  - ./autogen.sh
  - >-
    ./configure
    --infodir=$EMACSD/info
    --with-x-toolkit
    --with-x
    --without-xwidgets
    --with-ns
    --with-xft
    --with-pgtk
    --with-native-compilation=aot
    --without-tree-sitter
    --with-gnutls
    --without-compress-install
    --without-jpeg
    --without-webp
    --without-sound
    --without-pop
    --without-gif
    --without-tiff
    --without-dbus
    --without-gconf
    --without-gsettings
    --without-xaw3d
    --without-gpm
    --without-mailutils
    --without-imagemagick
    --without-libgmp
    --without-sqlite3
    --without-lcms2
    --without-cairo
    --disable-silent-rules
  - gmake V=1 -j3 bootstrap
  - gmake V=1 -j3
  - gmake V=1 -j3 install
  - mv nextstep/Emacs.app $_IVG_APP
skip:
  - |
    if [ -d "$_IVG_BACKUP" ]; then
      mv $_IVG_BACKUP $_IVG_APP
    fi
rollback:
  - |
    if [ -d "$_IVG_BACKUP" ]; then
      mv $_IVG_BACKUP $_IVG_APP
    fi
