uri: https://github.com/emacs-mirror/emacs.git
branch: master
locald: repos/emacs-gui
lock: locks/emacs-gui.lock
# emacs-30.2
shell:
  - "arch"
  - "--arm64e"
  - "/bin/bash"
env:
  _IVG_APP: /Applications/Emacs-GUI.app
  _IVG_BACKUP: "${_IVG_APP}.bk"
  MAKE_JOBS: 3
  BREW: /opt/homebrew/bin/brew
  CC: /usr/bin/clang
  MAC_CFLAGS: >-
    -O2
    -I/opt/homebrew/opt/libgccjit/include
    -I/opt/homebrew/opt/gcc/lib/gcc/current/gcc/aarch64-apple-darwin25/15/include
    -I/opt/homebrew/opt/tree-sitter@0.25/include/tree_sitter
  MAC_LIBS: >-
    -L/opt/homebrew/opt/libgccjit/lib/gcc/current
    -L/opt/homebrew/opt/tree-sitter@0.25/lib
  LIBRARY_PATH: >-
    /opt/homebrew/lib:/opt/homebrew/opt/libgccjit/lib/gcc/current:/opt/homebrew/opt/gcc/lib/gcc/current/gcc/aarch64-apple-darwin25/15:/opt/homebrew/opt/tree-sitter@0.25/lib
  PKG_CONFIG_PATH: >-
    /opt/homebrew/opt/tree-sitter@0.25/lib/pkgconfig
setup:
  - |
    if [ -d "$_IVG_APP" ]; then
      rm -rf $_IVG_BACKUP
      mv $_IVG_APP $_IVG_BACKUP
    else
      echo "First time installation..."
    fi
  - brew install --build-from-source gcc
  - brew install --build-from-source libgccjit
  - >-
    brew install
    llvm
    ncurses
    make
    autoconf
    gnu-sed
    gnu-tar
    grep
    awk
    coreutils
    pkg-config
    texinfo
    xz
    m4
    cmigemo
    gnutls
    gmp
    zlib
    gtk+
    tree-sitter@0.25
install:
  - >-
    ls -1 |
    sort -u |
    while read -r p ; do
      echo "$p"
      rm -rf "$p"
      git checkout -- "$p" | true
    done
  - |
    sudo mkdir -p /usr/local/share /usr/local/lib /usr/local/include /usr/local/libexec
    sudo chown -R $(whoami) /usr/local/share /usr/local/lib /usr/local/include /usr/local/libexec
  - ./autogen.sh
  - >-
    ./configure
    --infodir=$EMACSD/info
    --with-x-toolkit
    --with-x
    --without-xwidgets
    --with-ns
    --with-json
    --with-xft
    --with-pgtk
    --with-native-compilation=aot
    --with-tree-sitter
    --with-gnutls
    --without-compress-install
    --without-jpeg
    --without-webp
    --without-sound
    --without-pop
    --without-gif
    --without-tiff
    --without-dbus
    --without-gconf
    --without-gsettings
    --without-xaw3d
    --without-gpm
    --without-mailutils
    --without-imagemagick
    --without-libgmp
    --without-sqlite3
    --without-lcms2
    --without-cairo
    --disable-silent-rules
  - gmake V=1 -j${MAKE_JOBS} bootstrap
  - gmake V=1 -j${MAKE_JOBS}
  - gmake V=1 -j${MAKE_JOBS} install
  - mv nextstep/Emacs.app $_IVG_APP
skip:
  - |
    if [ -d "$_IVG_BACKUP" ]; then
      mv $_IVG_BACKUP $_IVG_APP
    fi
rollback:
  - |
    if [ -d "$_IVG_BACKUP" ]; then
      mv $_IVG_BACKUP $_IVG_APP
    fi
